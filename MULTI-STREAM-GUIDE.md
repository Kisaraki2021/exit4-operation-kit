# WebRTC複数ペア送受信機能 使用ガイド

## 概要

このシステムでは、複数の送信側（カメラ）と受信側（モニター）を独立して運用できます。
受信側は特定の送信側のIDを指定して、その映像のみを受信することができます。

## 新機能

### 📹 送信側の機能

1. **表示名の設定**
   - 送信側で識別しやすい名前を設定できます
   - 例: "カメラ1", "正面カメラ", "ステージ左"など
   - 設定した名前は自動的に保存されます

2. **ストリームIDの表示**
   - 一意のストリームIDが自動生成されます
   - このIDを受信側に伝えて接続します

3. **複数送信側の同時運用**
   - 複数のデバイスから同時に送信可能
   - 各送信側は独立して動作します

### 📺 受信側の機能

1. **送信側リストの表示**
   - 接続可能な送信側が自動的にリストアップされます
   - 表示名とIDが表示されます

2. **特定送信側への接続**
   - リストから選択、またはIDを入力して接続
   - 複数の送信側に同時接続可能

3. **接続状態の可視化**
   - 接続中の送信側は緑色で表示されます
   - 未接続の送信側はクリックして接続できます

## 使用方法

### ステップ1: 送信側のセットアップ

1. **送信側デバイスで送信ページにアクセス**
   ```
   https://10.0.12.197:3000/camera-sender.html
   ```

2. **表示名を入力**
   - わかりやすい名前を入力（例: "カメラ1"）
   - この名前は自動的に保存されます

3. **ストリームIDを確認**
   - 「あなたのID」に表示される英数字の文字列をメモ
   - このIDを受信側に伝えます

4. **カメラを起動**
   - 「📹 送信開始」ボタンをタップ
   - カメラとマイクの使用を許可

### ステップ2: 受信側のセットアップ

1. **受信側デバイスで受信ページにアクセス**
   ```
   https://10.0.12.197:3000/camera-receiver.html
   ```

2. **送信側を選択**
   
   **方法A: リストから選択（推奨）**
   - 「利用可能な送信側」リストから目的の送信側をクリック
   - 自動的に接続が開始されます

   **方法B: IDを入力**
   - 送信側から伝えられたIDを入力欄に入力
   - 「📡 接続」ボタンをクリック

3. **映像の確認**
   - 接続が成功すると映像が表示されます
   - 複数の送信側に接続する場合は、手順2を繰り返します

## 使用例

### 例1: 1対1の接続

```
送信側A (カメラ1, ID: abc123)
    ↓
受信側X → abc123 を指定して接続
```

### 例2: 1対多の接続（同じ映像を複数で受信）

```
送信側A (カメラ1, ID: abc123)
    ↓
    ├─ 受信側X → abc123 を指定
    ├─ 受信側Y → abc123 を指定
    └─ 受信側Z → abc123 を指定
```

### 例3: 多対1の接続（複数カメラを1つの画面で受信）

```
送信側A (カメラ1, ID: abc123) ─┐
送信側B (カメラ2, ID: def456) ─┼─→ 受信側X
送信側C (カメラ3, ID: ghi789) ─┘
```

受信側Xで:
1. abc123 を指定して接続
2. def456 を指定して接続
3. ghi789 を指定して接続

→ 3つの映像が同時に表示されます

### 例4: 多対多の接続（複数カメラを複数画面で受信）

```
送信側A (カメラ1, ID: abc123) ─┬─→ 受信側X (カメラ1のみ)
                                 └─→ 受信側Y (カメラ1+2)
送信側B (カメラ2, ID: def456) ───→ 受信側Y (カメラ1+2)
```

## トラブルシューティング

### 問題: 送信側リストに表示されない

**原因と解決方法:**
1. 送信側が「📹 送信開始」をクリックしていない
   → 送信側でカメラを起動してください

2. 送信側と受信側が異なるサーバーに接続している
   → 両方が同じURLでアクセスしているか確認

3. ネットワークの問題
   → ページを再読み込みしてください

### 問題: 接続しても映像が表示されない

**確認事項:**
1. 送信側でカメラが正常に起動しているか
2. WebSocketが接続されているか（画面上部の接続状態を確認）
3. ブラウザのコンソールでエラーを確認
4. STUNサーバーへの接続（インターネット接続が必要）

### 問題: 表示名が更新されない

**解決方法:**
- 送信側で表示名を入力後、少し待つ
- 受信側でページを再読み込み

### 問題: 複数の送信側に接続できない

**原因:**
- ブラウザやデバイスの性能による制限

**解決方法:**
- 同時接続数を減らす
- より高性能なデバイスを使用
- 解像度を下げる

## パフォーマンスのヒント

### 送信側

1. **解像度の調整**
   - デフォルト: 1280x720
   - パフォーマンスが悪い場合は、コードを編集して解像度を下げる

2. **接続数の制限**
   - 同時に接続する受信側が多いと帯域幅が圧迫されます
   - 必要最小限の接続に留める

### 受信側

1. **同時表示数**
   - 一度に多くの映像を表示すると負荷が高くなります
   - 必要な映像のみ接続する

2. **ハードウェアアクセラレーション**
   - ブラウザのハードウェアアクセラレーションを有効化
   - Chrome: chrome://settings → システム → ハードウェア アクセラレーション

## 技術仕様

### メッセージタイプ

#### 送信側 → サーバー
- `register`: 送信側として登録（streamId, displayName含む）
- `update-sender-info`: 表示名の更新
- `webrtc-offer`: WebRTC Offerの送信
- `webrtc-ice-candidate`: ICE候補の送信

#### 受信側 → サーバー
- `register`: 受信側として登録（receiverId含む）
- `request-sender-list`: 送信側リストの要求
- `request-connection`: 特定送信側への接続要求
- `webrtc-answer`: WebRTC Answerの送信
- `webrtc-ice-candidate`: ICE候補の送信

#### サーバー → クライアント
- `sender-list`: 送信側リスト
- `new-sender`: 新しい送信側の通知
- `sender-info-updated`: 送信側情報の更新通知
- `sender-disconnected`: 送信側の切断通知
- `webrtc-offer`, `webrtc-answer`, `webrtc-ice-candidate`: WebRTCシグナリング

### データフロー

```
送信側A                    サーバー                    受信側X
   |                          |                          |
   |-- register ------------->|                          |
   |    (streamId, name)       |                          |
   |                          |<-- request-sender-list --|
   |                          |-- sender-list ---------->|
   |                          |                          |
   |                          |<-- request-connection ---|
   |<-- new-receiver ---------|                          |
   |                          |                          |
   |-- webrtc-offer --------->|-- webrtc-offer --------->|
   |                          |<-- webrtc-answer --------|
   |<-- webrtc-answer --------|                          |
   |                          |                          |
   |<======= RTC接続確立 ==========================>|
   |                          |                          |
   |======== 映像ストリーム ========================>|
```

## よくある質問（FAQ）

### Q: 何台まで同時に送信できますか？
A: サーバーの性能とネットワーク帯域幅によります。一般的には10台程度まで可能です。

### Q: 受信側は何台の送信側に接続できますか？
A: デバイスの性能によりますが、通常4-6台程度が推奨です。

### Q: ストリームIDは変わりますか？
A: ページをリロードすると新しいIDが生成されます。固定IDが必要な場合は、コードをカスタマイズしてください。

### Q: 録画機能はありますか？
A: 現在の実装には含まれていません。ブラウザの録画拡張機能を使用するか、別途実装が必要です。

### Q: 音声も送信されますか？
A: はい、映像と音声の両方が送信されます。

### Q: LAN外から接続できますか？
A: ngrokやポートフォワーディングを使用すれば可能ですが、セキュリティに注意してください。

## 関連ドキュメント

- [カメラセットアップガイド](CAMERA_SETUP.md) - 詳細な技術情報
- [iOSアクセス手順](iOS-ACCESS.md) - iOSデバイスでの使用方法
- [README](README.md) - 全体的なセットアップガイド
