<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>カメラ映像受信 - 4番出口</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .video-item {
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .video-item video {
            width: 100%;
            height: auto;
            display: block;
        }

        .video-label {
            background: #667eea;
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="card">
            <h1>📺 カメラ映像受信</h1>

            <div class="connection-status" id="connection-status">接続中...</div>

            <div class="status-display">
                <div class="status-item">
                    <span class="status-label">受信中のストリーム数:</span>
                    <span class="status-value" id="stream-count">0</span>
                </div>
            </div>

            <div id="video-grid" class="video-grid">
                <!-- 受信したビデオストリームがここに追加されます -->
            </div>

            <div id="no-stream-message" style="text-align: center; color: #999; margin: 40px 0; font-size: 1.2em;">
                受信待機中...
            </div>

            <div class="button-group">
                <a href="/" class="nav-link">
                    <button class="btn">🏠 ホームに戻る</button>
                </a>
            </div>
        </div>
    </div>

    <script src="/js/websocket.js"></script>
    <script>
        const statusElement = document.getElementById('connection-status');
        const videoGrid = document.getElementById('video-grid');
        const streamCount = document.getElementById('stream-count');
        const noStreamMessage = document.getElementById('no-stream-message');

        let peerConnections = {}; // streamId -> RTCPeerConnection
        let streamCounter = 0;
        let myReceiverId = Math.random().toString(36).substr(2, 9); // この受信側のID

        // 接続状態の表示
        wsClient.onStatusChange((isConnected) => {
            if (isConnected) {
                statusElement.textContent = '✅ サーバーに接続されています';
                statusElement.className = 'connection-status connected';
                // サーバーに受信側として登録
                wsClient.send({
                    type: 'register',
                    role: 'receiver',
                    receiverId: myReceiverId
                });
            } else {
                statusElement.textContent = '❌ サーバーに接続されていません';
                statusElement.className = 'connection-status disconnected';
            }
        });

        // リモートストリームを表示
        function addRemoteStream(stream, streamId) {
            streamCounter++;

            const videoItem = document.createElement('div');
            videoItem.className = 'video-item';
            videoItem.id = `stream-${streamId}`;

            const label = document.createElement('div');
            label.className = 'video-label';
            label.textContent = `カメラ ${streamCounter} (ID: ${streamId})`;

            const video = document.createElement('video');
            video.autoplay = true;
            video.playsinline = true;
            video.srcObject = stream;

            videoItem.appendChild(label);
            videoItem.appendChild(video);
            videoGrid.appendChild(videoItem);

            updateStreamCount();
            console.log(`リモートストリームを表示しました (${streamId})`);
        }

        // ストリームを削除
        function removeStream(streamId) {
            const videoItem = document.getElementById(`stream-${streamId}`);
            if (videoItem) {
                videoItem.remove();
                updateStreamCount();
                console.log(`ストリームを削除しました (${streamId})`);
            }
        }

        // ストリーム数を更新
        function updateStreamCount() {
            const count = videoGrid.children.length;
            streamCount.textContent = count;

            if (count > 0) {
                noStreamMessage.style.display = 'none';
            } else {
                noStreamMessage.style.display = 'block';
            }
        }

        // 特定の送信側との接続を確立
        async function connectToSender(streamId) {
            try {
                console.log(`送信側に接続を要求 (${streamId})`);

                // サーバーに接続要求を送信
                wsClient.send({
                    type: 'request-connection',
                    streamId: streamId,
                    receiverId: myReceiverId
                });
            } catch (error) {
                console.error('接続要求エラー:', error);
            }
        }

        // WebRTC接続を処理
        wsClient.onMessage(async (data) => {
            try {
                // 既存の送信側リストを受信
                if (data.type === 'sender-list') {
                    console.log('送信側リスト:', data.senders);
                    data.senders.forEach(sender => {
                        connectToSender(sender.streamId);
                    });
                }
                // 新しい送信側を検出
                else if (data.type === 'new-sender') {
                    console.log('新しい送信側を検出:', data.streamId);
                    connectToSender(data.streamId);
                }
                // Offerを受信
                else if (data.type === 'webrtc-offer') {
                    const streamId = data.streamId;
                    console.log(`Offerを受信 (${streamId})`);

                    // 既存の接続があれば閉じる
                    if (peerConnections[streamId]) {
                        peerConnections[streamId].close();
                    }

                    const peerConnection = new RTCPeerConnection({
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' }
                        ]
                    });

                    // リモートストリームを受信
                    peerConnection.ontrack = (event) => {
                        console.log(`トラックを受信 (${streamId}):`, event.streams[0]);
                        if (event.streams && event.streams[0]) {
                            addRemoteStream(event.streams[0], streamId);
                        }
                    };

                    // ICE候補を送信
                    peerConnection.onicecandidate = (event) => {
                        if (event.candidate) {
                            console.log(`受信側ICE候補を送信 (${streamId})`);
                            wsClient.send({
                                type: 'webrtc-ice-candidate',
                                candidate: event.candidate,
                                streamId: streamId,
                                receiverId: myReceiverId
                            });
                        }
                    };

                    // 接続状態の監視
                    peerConnection.onconnectionstatechange = () => {
                        console.log(`受信側接続状態 (${streamId}):`, peerConnection.connectionState);
                        if (peerConnection.connectionState === 'disconnected' ||
                            peerConnection.connectionState === 'failed' ||
                            peerConnection.connectionState === 'closed') {
                            console.log(`接続が切断されました (${streamId})`);
                            removeStream(streamId);
                            delete peerConnections[streamId];
                        }
                    };

                    // Offerを設定してAnswerを作成
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);

                    console.log(`Answerを送信 (${streamId})`);
                    wsClient.send({
                        type: 'webrtc-answer',
                        answer: answer,
                        streamId: streamId,
                        receiverId: myReceiverId
                    });

                    peerConnections[streamId] = peerConnection;
                }
                // ICE候補を受信
                else if (data.type === 'webrtc-ice-candidate') {
                    const streamId = data.streamId;
                    const pc = peerConnections[streamId];
                    if (pc) {
                        console.log(`送信側からICE候補を受信 (${streamId})`);
                        await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
                    }
                }
                // 送信側が切断
                else if (data.type === 'sender-disconnected') {
                    const streamId = data.streamId;
                    console.log(`送信側が切断しました (${streamId})`);
                    if (peerConnections[streamId]) {
                        peerConnections[streamId].close();
                        delete peerConnections[streamId];
                    }
                    removeStream(streamId);
                }
            } catch (error) {
            console.error('WebRTC接続エラー:', error);
            console.error('エラー詳細:', error.stack);
        }
        });

        updateStreamCount();
    </script>
</body>

</html>