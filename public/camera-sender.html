<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚«ãƒ¡ãƒ©æ˜ åƒé€ä¿¡ - 4ç•ªå‡ºå£</title>
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>
    <div class="container">
        <div class="card">
            <h1>ğŸ“¹ ã‚«ãƒ¡ãƒ©æ˜ åƒé€ä¿¡</h1>

            <div class="connection-status" id="connection-status">æ¥ç¶šä¸­...</div>

            <!-- HTTPSè­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
            <div id="https-warning" style="display: none; background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; margin: 15px 0; color: #856404;">
                <strong>âš ï¸ è­¦å‘Š:</strong> HTTPæ¥ç¶šãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚<br>
                iOSãƒ‡ãƒã‚¤ã‚¹ã§ã‚«ãƒ¡ãƒ©ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯HTTPSæ¥ç¶šãŒå¿…è¦ã§ã™ã€‚<br>
                <small>ç¾åœ¨ã®URL: <code id="current-url"></code></small>
            </div>

            <!-- é€ä¿¡IDè¨­å®š -->
            <div class="status-display">
                <h2>é€ä¿¡å´è¨­å®š</h2>
                <div class="status-item">
                    <label for="sender-name" style="display: block; margin-bottom: 5px; font-weight: bold;">è¡¨ç¤ºå:</label>
                    <input type="text" id="sender-name" placeholder="ä¾‹: ã‚«ãƒ¡ãƒ©1, æ­£é¢ã‚«ãƒ¡ãƒ©" style="width: 100%; padding: 10px; font-size: 16px; border: 2px solid #667eea; border-radius: 5px;" />
                </div>
                <div class="status-item" style="margin-top: 10px;">
                    <span class="status-label">ã‚ãªãŸã®ID:</span>
                    <span class="status-value" id="my-stream-id" style="font-family: monospace; background: #f0f0f0; padding: 5px 10px; border-radius: 3px;">-</span>
                </div>
            </div>

            <div class="status-display">
                <h2>ã‚«ãƒ¡ãƒ©ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
                <div class="video-container">
                    <video id="local-video" autoplay playsinline muted></video>
                </div>
            </div>

            <div class="button-group">
                <button class="btn btn-success btn-large" id="start-btn">
                    ğŸ“¹ é€ä¿¡é–‹å§‹
                </button>
                <button class="btn btn-danger btn-large" id="stop-btn" style="display: none;">
                    â¹ï¸ é€ä¿¡åœæ­¢
                </button>
                <button class="btn btn-large" id="switch-camera-btn" style="display: none;">
                    ğŸ”„ ã‚«ãƒ¡ãƒ©åˆ‡æ›¿
                </button>
            </div>

            <div id="stream-status" class="status-display" style="display: none;">
                <div class="status-item">
                    <span class="status-label">é€ä¿¡çŠ¶æ…‹:</span>
                    <span class="status-value" id="stream-state">åœæ­¢ä¸­</span>
                </div>
                <div class="status-item">
                    <span class="status-label">ã‚«ãƒ¡ãƒ©:</span>
                    <span class="status-value" id="camera-type">æœªé¸æŠ</span>
                </div>
            </div>

            <div class="button-group">
                <a href="/" class="nav-link">
                    <button class="btn">ğŸ  ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
                </a>
            </div>
        </div>
    </div>

    <script src="/js/websocket.js"></script>
    <script>
        const statusElement = document.getElementById('connection-status');
        const localVideo = document.getElementById('local-video');
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const switchCameraBtn = document.getElementById('switch-camera-btn');
        const streamStatus = document.getElementById('stream-status');
        const streamState = document.getElementById('stream-state');
        const cameraType = document.getElementById('camera-type');
        const httpsWarning = document.getElementById('https-warning');
        const currentUrlElement = document.getElementById('current-url');
        const senderNameInput = document.getElementById('sender-name');
        const myStreamIdElement = document.getElementById('my-stream-id');

        // HTTPSçŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
        if (window.location.protocol !== 'https:' && 
            window.location.hostname !== 'localhost' && 
            window.location.hostname !== '127.0.0.1') {
            httpsWarning.style.display = 'block';
            currentUrlElement.textContent = window.location.href;
        }

        let localStream = null;
        let peerConnections = {}; // receiverId -> RTCPeerConnection
        let currentFacingMode = 'user'; // 'user' = ã‚¤ãƒ³ã‚«ãƒ¡ãƒ©, 'environment' = ã‚¢ã‚¦ãƒˆã‚«ãƒ¡ãƒ©
        let myStreamId = Math.random().toString(36).substr(2, 9); // ã“ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã®ID

        // ã‚¹ãƒˆãƒªãƒ¼ãƒ IDã‚’è¡¨ç¤º
        myStreamIdElement.textContent = myStreamId;

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å‰å›ã®è¡¨ç¤ºåã‚’å¾©å…ƒ
        const savedName = localStorage.getItem('senderName');
        if (savedName) {
            senderNameInput.value = savedName;
        }

        // è¡¨ç¤ºåãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰ä¿å­˜
        senderNameInput.addEventListener('input', () => {
            localStorage.setItem('senderName', senderNameInput.value);
            // ã‚µãƒ¼ãƒãƒ¼ã«æ›´æ–°ã‚’é€ä¿¡ï¼ˆæ¥ç¶šä¸­ã®å ´åˆï¼‰
            if (wsClient.ws && wsClient.ws.readyState === WebSocket.OPEN) {
                wsClient.send({
                    type: 'update-sender-info',
                    streamId: myStreamId,
                    displayName: senderNameInput.value || `é€ä¿¡å´-${myStreamId}`
                });
            }
        });

        // æ¥ç¶šçŠ¶æ…‹ã®è¡¨ç¤º
        wsClient.onStatusChange((isConnected) => {
            if (isConnected) {
                statusElement.textContent = 'âœ… ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã™';
                statusElement.className = 'connection-status connected';
                // ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡å´ã¨ã—ã¦ç™»éŒ²
                wsClient.send({
                    type: 'register',
                    role: 'sender',
                    streamId: myStreamId,
                    displayName: senderNameInput.value || `é€ä¿¡å´-${myStreamId}`
                });
            } else {
                statusElement.textContent = 'âŒ ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“';
                statusElement.className = 'connection-status disconnected';
            }
        });

        // ã‚«ãƒ¡ãƒ©ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’é–‹å§‹
        async function startCamera() {
            try {
                // HTTPSãƒã‚§ãƒƒã‚¯ï¼ˆiOSã§ã¯å¿…é ˆï¼‰
                if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                    alert('iOSãƒ‡ãƒã‚¤ã‚¹ã§ã¯HTTPSæ¥ç¶šãŒå¿…è¦ã§ã™ã€‚\nhttps:// ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                // getUserMediaã®ã‚µãƒãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    alert('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚\næœ€æ–°ã®ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ã”ä½¿ç”¨ãã ã•ã„ã€‚');
                    return;
                }

                const constraints = {
                    video: {
                        facingMode: currentFacingMode,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: true
                };

                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                localVideo.srcObject = localStream;

                cameraType.textContent = currentFacingMode === 'user' ? 'ã‚¤ãƒ³ã‚«ãƒ¡ãƒ©' : 'ã‚¢ã‚¦ãƒˆã‚«ãƒ¡ãƒ©';
                streamState.textContent = 'é€ä¿¡ä¸­';
                streamState.style.color = '#56ab2f';
                streamStatus.style.display = 'block';

                startBtn.style.display = 'none';
                stopBtn.style.display = 'inline-block';
                switchCameraBtn.style.display = 'inline-block';

                // ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡é–‹å§‹ã‚’é€šçŸ¥ï¼ˆæ—¢å­˜ã®å—ä¿¡å´ã«æ¥ç¶šï¼‰
                console.log('é€ä¿¡é–‹å§‹ã‚’é€šçŸ¥');

            } catch (error) {
                console.error('ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼:', error);
                let errorMessage = 'ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\n\n';
                
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorMessage += 'ã‚«ãƒ¡ãƒ©ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ã‚«ãƒ¡ãƒ©ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚';
                } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                    errorMessage += 'ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚\nãƒ‡ãƒã‚¤ã‚¹ã«ã‚«ãƒ¡ãƒ©ãŒæ¥ç¶šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                    errorMessage += 'ã‚«ãƒ¡ãƒ©ãŒä»–ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ä½¿ç”¨ä¸­ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚';
                } else if (error.name === 'OverconstrainedError' || error.name === 'ConstraintNotSatisfiedError') {
                    errorMessage += 'æŒ‡å®šã•ã‚ŒãŸã‚«ãƒ¡ãƒ©è¨­å®šãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚';
                } else if (error.name === 'TypeError') {
                    errorMessage += 'HTTPSæ¥ç¶šãŒå¿…è¦ã§ã™ã€‚\nhttps:// ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚';
                } else {
                    errorMessage += error.message;
                }
                
                alert(errorMessage);
            }
        }

        // ã‚«ãƒ¡ãƒ©ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢
        function stopCamera() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
                localVideo.srcObject = null;
            }

            // ã™ã¹ã¦ã®ãƒ”ã‚¢æ¥ç¶šã‚’é–‰ã˜ã‚‹
            Object.values(peerConnections).forEach(pc => pc.close());
            peerConnections = {};

            streamState.textContent = 'åœæ­¢ä¸­';
            streamState.style.color = '#999';
            cameraType.textContent = 'æœªé¸æŠ';

            startBtn.style.display = 'inline-block';
            stopBtn.style.display = 'none';
            switchCameraBtn.style.display = 'none';
        }

        // ã‚«ãƒ¡ãƒ©ã‚’åˆ‡ã‚Šæ›¿ãˆ
        async function switchCamera() {
            currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
            stopCamera();
            await startCamera();
        }

        // WebRTCæ¥ç¶šã‚’é–‹å§‹ï¼ˆå—ä¿¡å´ã”ã¨ã«ä½œæˆï¼‰
        async function createPeerConnection(receiverId) {
            try {
                const peerConnection = new RTCPeerConnection({
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                });

                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’è¿½åŠ 
                console.log(`ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒªãƒ¼ãƒ ã®ãƒˆãƒ©ãƒƒã‚¯æ•°: ${localStream.getTracks().length}`);
                localStream.getTracks().forEach(track => {
                    console.log(`ãƒˆãƒ©ãƒƒã‚¯ã‚’è¿½åŠ : ${track.kind} (${track.id})`);
                    peerConnection.addTrack(track, localStream);
                });

                // æ¥ç¶šçŠ¶æ…‹ã®ç›£è¦–
                peerConnection.onconnectionstatechange = () => {
                    console.log(`é€ä¿¡å´æ¥ç¶šçŠ¶æ…‹ (${receiverId}):`, peerConnection.connectionState);
                };

                // ICEå€™è£œã‚’é€ä¿¡
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        console.log(`é€ä¿¡å´ICEå€™è£œã‚’é€ä¿¡ (${receiverId})`);
                        wsClient.send({
                            type: 'webrtc-ice-candidate',
                            candidate: event.candidate,
                            streamId: myStreamId,
                            receiverId: receiverId
                        });
                    }
                };

                // Offerã‚’ä½œæˆã—ã¦é€ä¿¡
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);

                console.log(`Offerã‚’é€ä¿¡ (${receiverId})`);
                wsClient.send({
                    type: 'webrtc-offer',
                    offer: offer,
                    streamId: myStreamId,
                    receiverId: receiverId
                });

                peerConnections[receiverId] = peerConnection;

            } catch (error) {
                console.error('WebRTCæ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
                alert('WebRTCæ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // WebRTCã‚·ã‚°ãƒŠãƒªãƒ³ã‚°
        wsClient.onMessage(async (data) => {
            try {
                // æ–°ã—ã„å—ä¿¡å´ãŒæ¥ç¶šã—ãŸå ´åˆ
                if (data.type === 'new-receiver' && localStream) {
                    console.log('æ–°ã—ã„å—ä¿¡å´ã‚’æ¤œå‡º:', data.receiverId);
                    await createPeerConnection(data.receiverId);
                }
                // Answerã‚’å—ä¿¡
                else if (data.type === 'webrtc-answer') {
                    const receiverId = data.receiverId;
                    const pc = peerConnections[receiverId];
                    if (pc) {
                        console.log(`Answerã‚’å—ä¿¡ (${receiverId})`);
                        await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                    }
                }
                // ICEå€™è£œã‚’å—ä¿¡
                else if (data.type === 'webrtc-ice-candidate' && data.streamId === myStreamId) {
                    const receiverId = data.receiverId;
                    const pc = peerConnections[receiverId];
                    if (pc) {
                        console.log(`å—ä¿¡å´ã‹ã‚‰ICEå€™è£œã‚’å—ä¿¡ (${receiverId})`);
                        await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
                    }
                }
                // å—ä¿¡å´ãŒåˆ‡æ–­ã—ãŸå ´åˆ
                else if (data.type === 'receiver-disconnected') {
                    const receiverId = data.receiverId;
                    if (peerConnections[receiverId]) {
                        peerConnections[receiverId].close();
                        delete peerConnections[receiverId];
                        console.log(`å—ä¿¡å´ãŒåˆ‡æ–­ã—ã¾ã—ãŸ (${receiverId})`);
                    }
                }
            } catch (error) {
                console.error('ã‚·ã‚°ãƒŠãƒªãƒ³ã‚°å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
            }
        });

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        startBtn.addEventListener('click', startCamera);
        stopBtn.addEventListener('click', stopCamera);
        switchCameraBtn.addEventListener('click', switchCamera);
    </script>
</body>

</html>